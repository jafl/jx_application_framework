/******************************************************************************
 GLPrefsMgr.cpp

	<Description>

	BASE CLASS = public JXPrefsManager

	Copyright (C) 1998 by Glenn W. Bach.
	
	Base code generated by Codemill v0.1.0

 *****************************************************************************/

#include <GLPrefsMgr.h>
#include <GLFitDirector.h>
#include <GLGlobals.h>

#include <JXChooseSaveFile.h>
#include <JXPTPrinter.h>
#include <JXWindow.h>

#include <JPtrArray-JString.h>
#include <jDirUtil.h>
#include <unistd.h>
#include <jAssert.h>

const JFileVersion kCurrentPrefsFileVersion = 2;

/******************************************************************************
 Constructor

 *****************************************************************************/

GLPrefsMgr::GLPrefsMgr
	(
	bool* isNew
	)
	:
   JXPrefsManager(kCurrentPrefsFileVersion, true)
{
	*isNew = JPrefsManager::UpgradeData();
	JXGetChooseSaveFile()->SetPrefInfo(this, kChooseSaveFilePrefsID);
	JXGetChooseSaveFile()->JPrefObject::ReadPrefs();
}

/******************************************************************************
 Destructor

 *****************************************************************************/

GLPrefsMgr::~GLPrefsMgr()
{
	JXGetChooseSaveFile()->JPrefObject::WritePrefs();
	SetData(kProgramVersionID, JGetString("VERSION"));
	SaveToDisk();
}

/******************************************************************************
 GetGloveVersionStr

 ******************************************************************************/

JString
GLPrefsMgr::GetGloveVersionStr()
	const
{
	std::string data;
	if (GetData(kProgramVersionID, &data))
		{
		return JString(data);
		}
	else
		{
		return JString("< 0.8.0");		// didn't exist before this version
		}
}

/******************************************************************************
 UpgradeData (virtual protected)

 ******************************************************************************/

void
GLPrefsMgr::UpgradeData
	(
	const bool		isNew,
	const JFileVersion	currentVersion
	)
{
	if (isNew)
		{
		}
}

/******************************************************************************
 Receive (virtual protected)

 ******************************************************************************/

void
GLPrefsMgr::Receive
	(
	JBroadcaster* 	sender, 
	const Message&	message
	)
{
//	if (sender == itsEditPrefsDialog && message.Is(JXDialogDirector::kDeactivated))
//		{
//		const JXDialogDirector::Deactivated* info =
//			dynamic_cast<const JXDialogDirector::Deactivated*>(&message);
//		assert( info != nullptr );
//		if (info->Successful())
//			{
//			UpdatePrefs(itsEditPrefsDialog);
//			}
//		itsEditPrefsDialog = nullptr;
//		}
}

/******************************************************************************
 EditPrefs

 ******************************************************************************/

void
GLPrefsMgr::EditPrefs()
{
}

/******************************************************************************
 GetWindowSize (private)

 ******************************************************************************/

void
GLPrefsMgr::GetWindowSize
	(
	const JPrefID	id,
	JXWindow*		window
	)
	const
{
	if (IDValid(id))
		{
		std::string data;
		GetData(id, &data);
		std::istringstream dataStream(data);
		window->ReadGeometry(dataStream);
		}
}

/******************************************************************************
 SaveWindowSize (private)

 ******************************************************************************/

void
GLPrefsMgr::SaveWindowSize
	(
	const JPrefID	id,
	JXWindow*		window
	)
{
	std::ostringstream data;
	window->WriteGeometry(data);
	const JPoint dtl = window->GetDesktopLocation();
	window->Place(dtl.x, dtl.y);

	SetData(id, data);
}

/******************************************************************************
 PrinterSetup

 ******************************************************************************/

void
GLPrefsMgr::WritePrinterSetup
	(
	JXPTPrinter* printer
	)
{
	std::ostringstream data;
	printer->WriteXPTSetup(data);
	SetData(kPTPrinterSetupID, data);
}

void
GLPrefsMgr::ReadPrinterSetup
	(
	JXPTPrinter* printer
	)
{
	if (IDValid(kPTPrinterSetupID))
		{
		std::string data;
		GetData(kPTPrinterSetupID, &data);
		std::istringstream dataStream(data);
		printer->ReadXPTSetup(dataStream);
		}
}

/******************************************************************************
 FitDirectorSetup

 ******************************************************************************/

void
GLPrefsMgr::WriteFitDirectorSetup
	(
	GLFitDirector* dir
	)
{
	std::ostringstream data;
	dir->WritePrefs(data);
	SetData(kFitDirectorID, data);
}

void
GLPrefsMgr::ReadFitDirectorSetup
	(
	GLFitDirector* dir
	)
{
	if (IDValid(kFitDirectorID))
		{
		std::string data;
		GetData(kFitDirectorID, &data);
		std::istringstream dataStream(data);
		dir->ReadPrefs(dataStream);
		}
}
