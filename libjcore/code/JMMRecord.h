/******************************************************************************
 JMMRecord.h

	Interface for the JMMRecord class.

	Copyright (C) 1997 by Dustin Laurence.

	Base code generated by Codemill v0.1.0

 *****************************************************************************/

#ifndef _H_JMMRecord
#define _H_JMMRecord

#include "jTypes.h"

#include <stdlib.h> // For size_t

	class JString;

// A POD type with the same data members as JMMRecord
struct JMMRecordData
{
	// We could easily be storing 50,000 or more entries, so using the minimum
	// possible space is crucial.  You can use PrintLayout() to help choose the
	// layout and types carefully for a given architecture.

	// These quantities are those most likely to be > 32 bits on some
	// architectures, so keep them together
	const void*      itsAddress;
	const JUtf8Byte* itsNewFile;
	const JUtf8Byte* itsDeleteFile;
	size_t           itsSize;       // Likely sizeof(size_t) == sizeof(void*)

	// These don't need to be 64 bits on 64-bit architectures, and
	// shouldn't be 16 bits on 16-bit int implementations, so we can use
	// 32-bit quantities and hope that the compiler will not align them on
	// 64-bits on 64-bit architectures.  If anyone has a source file with
	// 4.3 billion lines or code that needs to allocate 4.3*10^9 memory
	// blocks, *please* contact the JX team.  And then seek help! :-)

	JUInt32  itsID;
	JUInt32  itsNewLine;
	JUInt32  itsDeleteLine;

	unsigned itsArrayNewFlag      :1;
	unsigned itsArrayDeleteFlag   :1;
	unsigned itsManagerMemoryFlag :1;
	unsigned itsLibraryMemoryFlag :1;
	unsigned itsAppMemoryFlag     :1;
	unsigned itsBucket1MemoryFlag :1;
	unsigned itsBucket2MemoryFlag :1;
	unsigned itsBucket3MemoryFlag :1;
};

class JMMRecord : private JMMRecordData
{
public:

	enum Type
	{
		kManager = -2,
		kLibrary = -1,
		kApp     = 0,
		kBucket1 = 1,
		kBucket2 = 2,
		kBucket3 = 3
	};

public:

	JMMRecord();
	JMMRecord(const JUInt32 id, const void* address, const size_t size,
			  const JUtf8Byte* file, const JUInt32 lineNumber,
			  const bool array, const int type);
	// Save 4 bytes (on many architectures) by having no virtuals, even the destructor
	// ~JMMRecord() override; // Warning: not virtual!

	// Accept built-in version!
	//	JMMRecord(const JMMRecord& source);
	// Why won't the compiler generate a built-in version for this one?  Bit-fields?
	// JMMRecord& operator=(const JMMRecord& source);

	JUInt32          GetID() const;

	const void*      GetAddress() const;
	size_t           GetSize() const;

	const JUtf8Byte* GetNewFile() const;
	JUInt32          GetNewLine() const;

	const JUtf8Byte* GetDeleteFile() const;
	JUInt32          GetDeleteLine() const;

	void SetDeleteLocation(const JUtf8Byte* deleteFile, const JSize deleteLine,
						   const bool arrayDelete);

	bool IsDeleted() const;

	bool IsArrayNew() const;
	bool IsArrayDelete() const;

	const JUtf8Byte* NewTypeName() const;
	const JUtf8Byte* DeleteTypeName() const;

	static const JUtf8Byte* TypeName(const unsigned isArray);

	bool    IsManagerMemory() const;
	bool    IsLibraryMemory() const;
	bool    IsAppMemory() const;
	int		GetMemoryBucket() const;

	void	StreamForDebug(std::ostream& output) const;
	void	PrintLayout() const;
};

/******************************************************************************
 GetID

 *****************************************************************************/

inline JUInt32
JMMRecord::GetID() const
{
	return itsID;
}

/******************************************************************************
 GetAddress

 *****************************************************************************/

inline const void*
JMMRecord::GetAddress() const
{
	return itsAddress;
}

/******************************************************************************
 GetSize

 *****************************************************************************/

inline size_t
JMMRecord::GetSize() const
{
	return itsSize;
}

/******************************************************************************
 GetNewFile

 *****************************************************************************/

inline const JUtf8Byte*
JMMRecord::GetNewFile() const
{
	return itsNewFile;
}

/******************************************************************************
 GetNewLine

 *****************************************************************************/

inline JUInt32
JMMRecord::GetNewLine() const
{
	return itsNewLine;
}

/******************************************************************************
 GetDeleteFile

 *****************************************************************************/

inline const JUtf8Byte*
JMMRecord::GetDeleteFile() const
{
	return itsDeleteFile;
}

/******************************************************************************
 GetDeleteLine

 *****************************************************************************/

inline JUInt32
JMMRecord::GetDeleteLine() const
{
	return itsDeleteLine;
}

/******************************************************************************
 IsDeleted

 *****************************************************************************/

inline bool
JMMRecord::IsDeleted() const
{
	return itsDeleteFile != nullptr;
}

/******************************************************************************
 IsArrayNew

 *****************************************************************************/

inline bool
JMMRecord::IsArrayNew() const
{
	return itsArrayNewFlag;
}

/******************************************************************************
 IsArrayDelete

 *****************************************************************************/

inline bool
JMMRecord::IsArrayDelete() const
{
	return itsArrayDeleteFlag;
}

/******************************************************************************
 IsManagerMemory

 *****************************************************************************/

inline bool
JMMRecord::IsManagerMemory() const
{
	return itsManagerMemoryFlag;
}

/******************************************************************************
 IsLibraryMemory

 *****************************************************************************/

inline bool
JMMRecord::IsLibraryMemory() const
{
	return itsLibraryMemoryFlag;
}

/******************************************************************************
 IsAppMemory

 *****************************************************************************/

inline bool
JMMRecord::IsAppMemory() const
{
	return itsAppMemoryFlag;
}

/******************************************************************************
 GetMemoryBucket

 *****************************************************************************/

inline int
JMMRecord::GetMemoryBucket() const
{
	return (itsLibraryMemoryFlag ? -1 :
			itsAppMemoryFlag     ? 0  :
			itsBucket1MemoryFlag ? 1  :
			itsBucket2MemoryFlag ? 2  :
			itsBucket3MemoryFlag ? 3  : -2);
}

#endif
