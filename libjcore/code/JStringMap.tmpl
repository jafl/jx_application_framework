#ifndef _T_JStringMap
#define _T_JStringMap

/******************************************************************************
 JStringMap.tmpl

	BASE CLASS = JHashTable< JStrValue<V> >

	Copyright (C) 1997 by Dustin Laurence.
	
	Base code generated by Codemill v0.1.0

 *****************************************************************************/

#include "jAssert.h"

/******************************************************************************
 Constructor

 *****************************************************************************/

template <class V>
JStringMap<V>::JStringMap
	(
	const JSize lgSize // = kJDefaultLgMinTableSize
	)
	:
	JHashTable< JStrValue<V> >(lgSize)
{
	JHashTable< JStrValue<V> >::DisallowCursors();
}

/******************************************************************************
 Destructor

 *****************************************************************************/

template <class V>
JStringMap<V>::~JStringMap()
{
	RemoveAll();
}

/******************************************************************************
 Contains

	*** This code is also used to position the cursor for use by other
		functions in both this class and derived classes!

 *****************************************************************************/

template <class V>
bool
JStringMap<V>::Contains
	(
	const JString& key
	)
	const
{
	auto* cursor = JHashTable< JStrValue<V> >::GetCursor();
	// We know the hash value does not depend on V, so this is safe
	JStrValue<V> hashEntry;
	hashEntry.key = &key;
	cursor->ResetKey(hashEntry);
	return cursor->NextKey();
}

/******************************************************************************
 GetItem

	If the element is found, sets value to it and returns true; otherwise,
	leaves value unmodified and returns false.

 *****************************************************************************/

template <class V>
bool
JStringMap<V>::GetItem
	(
	const JString& key,
	V*             value
	)
	const
{
	if (Contains(key))
	{
		*value = JHashTable< JStrValue<V> >::GetCursor()->GetValue().value;
		return true;
	}
	else
	{
		return false;
	}
}

/******************************************************************************
 SetItem (protected)

	The element is set if it already existed and 'type' is kIfOld or kAlways
	(the default) or if it did not exist and 'type' is kIfNew or kAlways.

	Returns true if the element was set, false otherwise.
	*existed is set to true if there was something already there.

 *****************************************************************************/

template <class V>
bool
JStringMap<V>::SetItem
	(
	const JString&              key,
	const V&                    value,
	const JPtrArrayT::SetAction action,
	const JStringMapT::SetType  type,
	bool*                       existed
	)
{
	auto* cursor = JHashTable< JStrValue<V> >::GetCursor();
	JStrValue<V> hashEntry(&key, value);

	cursor->ResetKey(hashEntry);
	cursor->ForceNextMapInsertKey();

	if ( cursor->IsFull() )
	{
		*existed = true;
		if (type == JStringMapT::kIfNew)
		{
			return false;
		}

		PrepareForSet(action);

		// Otherwise we'd pass in the client's key!
		hashEntry.key = cursor->GetValue().key;
		cursor->Set(hashEntry);
		return true;
	}
	else
	{
		*existed = false;
		if (type == JStringMapT::kIfOld)
		{
			return false;
		}

		hashEntry.key = jnew JString(key);
		cursor->Set(cursor->GetCursorHashValue(), hashEntry);

		return true;
	}
}

/******************************************************************************
 PrepareForSet (virtual protected)

	Operates on the cursor's element.

 *****************************************************************************/

template <class V>
void
JStringMap<V>::PrepareForSet
	(
	const JPtrArrayT::SetAction action
	)
{
	assert( action == JPtrArrayT::kForget );
}

/******************************************************************************
 RemoveItem (protected)

 *****************************************************************************/

template <class V>
bool
JStringMap<V>::RemoveItem
	(
	const JString&              key,
	const JPtrArrayT::SetAction action
	)
{
	if (Contains(key))
	{
		PrepareForSet(action);

		auto* cursor = JHashTable< JStrValue<V> >::GetCursor();
		jdelete const_cast<JString*>(cursor->GetValue().key);

		cursor->Remove();
		return true;
	}
	else
	{
		return false;
	}
}

/******************************************************************************
 RemoveAll (protected)

 *****************************************************************************/

template <class V>
void
JStringMap<V>::RemoveAll
	(
	const JPtrArrayT::SetAction action
	)
{
	if (!JHashTable< JStrValue<V> >::IsEmpty())
	{
		auto* cursor = JHashTable< JStrValue<V> >::GetCursor();
		cursor->Reset();
		while ( cursor->NextFull() )
		{
			PrepareForSet(action);

			// delete, but don't mark empty to avoid multiple resizing
			jdelete const_cast<JString*>(cursor->GetValue().key);
		}
	}

	// Mark all at once and possibly resize; we want to call even if the
	// hash table is already empty to zero out the load count
	JHashTable< JStrValue<V> >::MarkAllEmpty();
}

#endif
